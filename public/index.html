<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>ARC CLASSES</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0f172a; --gold: #fbbf24; --light: #f8fafc; --red: #ef4444; --dark: #1e293b; --purple: #a855f7; --green: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; color: #333; min-width: 1200px; }
        
        @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .logo { font-size: 2rem; font-weight: 900; letter-spacing: 2px; background: linear-gradient(270deg, #ff0000, #fbbf24, #00ff00, #0000ff, #ff00ff); background-size: 400% 400%; -webkit-background-clip: text; color: transparent; animation: rainbow 6s ease infinite; }
        
        nav { background: var(--primary); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .menu a { color: white; margin-left: 25px; text-decoration: none; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        .menu a:hover { color: var(--gold); }
        
        .section { display: none; padding: 40px; max-width: 1100px; margin: auto; }
        .section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* COMPONENTS */
        .hero { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; padding: 80px 40px; border-radius: 20px; text-align: center; margin-bottom: 40px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .hero h1 { font-size: 3rem; margin: 0; color: var(--gold); }
        .cta-btn { padding: 15px 40px; font-size: 1.2rem; background: var(--gold); color: var(--primary); border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .cta-btn:hover { transform: scale(1.05); }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; display:flex; flex-direction:column; }
        .card:hover { transform: translateY(-5px); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .book-cover { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; border:1px solid #eee; }
        
        .btn-gold { background: var(--gold); color: var(--primary); padding: 12px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        .btn-red { background: var(--red); color: white; padding: 12px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        .form-box { max-width: 600px; margin: 40px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        
        /* BLINKING BLOGS */
        @keyframes blinker { 50% { opacity: 0.7; } }
        .blink-anim { animation: blinker 2s linear infinite; }
        .blog-text { max-height: 80px; overflow: hidden; transition: max-height 0.3s; }
        .blog-text.expanded { max-height: 1000px; }
        
        /* EXAM UI */
        .exam-container { display: flex; height: 80vh; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #ddd; }
        .exam-left { flex: 3; padding: 40px; overflow-y: auto; border-right: 1px solid #eee; }
        .exam-right { flex: 1; background: #f8fafc; padding: 20px; display: flex; flex-direction: column; border-left: 1px solid #eee; }
        .q-image { max-width: 100%; max-height: 300px; display: block; margin: 20px 0; border: 1px solid #ddd; border-radius: 5px; }
        .option-label { display: flex; align-items: center; padding: 15px; border: 2px solid #eee; margin: 10px 0; cursor: pointer; border-radius: 8px; transition: 0.2s; font-size: 1.1rem; }
        .option-label:hover { background: #f1f5f9; border-color: var(--primary); }
        .option-label input { margin-right: 15px; transform: scale(1.5); }
        .palette-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .p-btn { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; background: white; font-size: 1rem; }
        .p-btn.answered { background: var(--green); color: white; border-color: var(--green); }
        .p-btn.visited { background: var(--purple); color: white; border-color: var(--purple); }
        .p-btn.active { border: 3px solid var(--primary); transform: scale(1.1); }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal-box { background:white; padding:40px; border-radius:20px; width:500px; text-align:center; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }
    </style>
</head>
<body>

<nav>
    <div class="logo">ARC CLASSES</div>
    <div class="menu">
        <a onclick="show('home')">Home</a>
        <a onclick="show('notes')">Library</a>
        <a onclick="show('tests')">Tests</a>
        <a onclick="show('results')">Results</a>
        <a onclick="show('login')" id="login-nav">Login</a>
        <a id="teacher-nav" onclick="show('admin')" style="display:none; color:var(--red)">TEACHER PANEL</a>
        <a onclick="logout()" id="logout-btn" style="display:none">(Logout)</a>
    </div>
</nav>

<div id="home" class="section active">
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <input id="home-search" placeholder="üîç Search Books & Notes..." style="flex:1; padding:15px; font-size:1.1rem; border:2px solid var(--primary);" onkeyup="filterNotes()">
        <button class="btn-gold" onclick="filterNotes()">Search</button>
    </div>
    <div id="announce-bar" style="background:var(--gold); color:var(--primary); padding:15px; font-weight:bold; border-radius:8px; margin-bottom:30px; font-size:1.1rem;">üì¢ Loading...</div>
    
    <h3 style="color:var(--primary)">Latest Blogs</h3>
    <div id="blog-container" class="grid blink-anim" style="margin-bottom:40px;"></div>

    <div class="hero">
        <h1>Master Chemistry with ARC</h1>
        <p>Premium Notes, GATE-Style Tests, and Expert Guidance.</p>
        <button class="cta-btn" onclick="show('tests')">Start a Test Now</button>
    </div>
</div>

<div id="notes" class="section"><h2>üìö Library</h2><div id="mat-list" class="grid">Loading...</div></div>

<div id="tests" class="section"><h2>üìù Online Tests (Max 3 Attempts)</h2><div id="test-list" class="grid">Loading...</div></div>

<div id="exam-ui" class="section" style="max-width:100%; padding:0;">
    <div class="exam-container">
        <div class="exam-left">
            <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--primary)">Question <span id="q-num">1</span></h3>
                <span style="font-weight:bold; font-size:1.2rem;"><span style="color:var(--green)">+<span id="q-marks">0</span></span> / <span style="color:var(--red)">-<span id="q-neg">0</span></span></span>
            </div>
            <p id="q-text" style="font-size:1.3rem; line-height:1.6;"></p>
            <img id="q-image-display" class="q-image" style="display:none;">
            <div id="q-options"></div>
            <div style="margin-top:40px; display:flex; gap:15px;">
                <button class="btn-gold" style="background:white; border:2px solid #333; color:#333;" onclick="navQ(-1)">‚Üê Previous</button>
                <button class="btn-red" style="background:white; color:var(--red); border:2px solid var(--red);" onclick="clearResponse()">Clear Response</button>
                <button class="btn-gold" style="flex:1" onclick="saveAndNext()">Save & Next ‚Üí</button>
            </div>
        </div>
        <div class="exam-right">
            <div style="background:var(--primary); color:var(--gold); padding:20px; text-align:center; font-size:1.8rem; font-weight:800; border-radius:10px; margin-bottom:20px;" id="timer">00:00</div>
            <div style="font-size:1.1rem; margin-bottom:20px;"><strong>Student: </strong><span id="student-name-display">...</span></div>
            <div style="flex:1; overflow-y:auto;">
                <p><strong>Palette:</strong> <span style="color:var(--green)">‚óè Done</span> <span style="color:var(--purple)">‚óè Visited</span></p>
                <div class="palette-grid" id="palette"></div>
            </div>
            <button class="btn-red" style="width:100%; padding:20px; font-size:1.2rem;" onclick="submitExam()">SUBMIT TEST</button>
        </div>
    </div>
</div>

<div id="results" class="section"><h2>üèÜ Results Board</h2><div id="offline-results-list"></div></div>

<div id="login" class="section">
    <div class="form-box">
        <h2>Login</h2>
        <input id="l-email" placeholder="Email"><input id="l-pass" type="password" placeholder="Password">
        <button class="btn-gold" style="width:100%" onclick="handleLogin()">Login</button>
        <p style="text-align:center; cursor:pointer; color:blue" onclick="toggleReg()">New? Register</p>
        <p style="text-align:center; font-size:0.9rem; color:#999">Teacher? (admin@arc.com)</p>
    </div>
    <div id="reg-box" class="form-box" style="display:none">
        <h2>Register</h2><p style="color:red">‚ö†Ô∏è Remember your details.</p>
        <input id="r-name" placeholder="Name">
        <div style="display:flex; align-items:center; gap:10px"><input id="r-prefix" placeholder="username" style="text-align:right"><span>@arcstudent.com</span></div>
        <input id="r-pass" type="password" placeholder="Password">
        <button class="btn-gold" style="width:100%" onclick="handleReg()">Register Now</button>
    </div>
</div>

<div id="admin" class="section">
    <h2>üë®‚Äçüè´ Teacher Dashboard</h2>
    <div style="display:flex; gap:15px; margin-bottom:30px; flex-wrap:wrap;">
        <button class="btn-gold" onclick="showAdminTab('create-test')">Create Test</button>
        <button class="btn-gold" onclick="showAdminTab('upload-mat')">Upload Material</button>
        <button class="btn-gold" onclick="showAdminTab('upload-res')">Offline Result</button>
        <button class="btn-gold" onclick="showAdminTab('create-blog')">Post Blog</button>
        <button class="btn-gold" onclick="showAdminTab('announce')">Announcement</button>
        <button class="btn-gold" onclick="showAdminTab('online-res')">Online Reports</button>
        <button class="btn-gold" onclick="showAdminTab('students')">Students</button>
        <button class="btn-red" onclick="showAdminTab('manage')">Delete Items</button>
    </div>
    
    <div id="adm-students" style="display:none"><h3>Students</h3><table id="student-table"></table></div>
    <div id="adm-online-res" style="display:none"><h3>Online Results</h3><table id="online-res-table"></table></div>
    <div id="adm-manage" style="display:none"><h3>Delete Content</h3><div id="manage-list"></div></div>
    
    <div id="adm-announce" style="display:none"><div class="form-box" style="margin:0"><h3>Announcement</h3><textarea id="ann-text"></textarea><button class="btn-gold" onclick="updateAnnouncement()">Update</button></div></div>

    <div id="adm-create-blog" style="display:none"><div class="form-box" style="margin:0"><h3>Post Blog</h3><input id="b-title" placeholder="Title"><textarea id="b-content" rows="5" placeholder="Content"></textarea><p>Image:</p><input type="file" id="b-img-file" accept="image/*"><div style="margin:10px 0"><label>Title Color: <input type="color" id="b-h-color"></label> <label>Text Color: <input type="color" id="b-p-color" value="#ffffff"></label></div><button class="btn-gold" onclick="createBlog()">Publish</button></div></div>

    <div id="adm-upload-mat" style="display:none"><div class="form-box" style="margin:0"><h3>Upload Note</h3><input id="m-title" placeholder="Title"><input id="m-desc" placeholder="Desc"><input id="m-link" placeholder="Drive Link"><input id="m-code" placeholder="Password"><p>Cover:</p><input type="file" id="m-img-file" accept="image/*"><button class="btn-gold" onclick="uploadMaterial()">Upload</button></div></div>

    <div id="adm-upload-res" style="display:none"><div class="form-box" style="margin:0"><h3>Offline Result</h3><input id="off-title" placeholder="Test Name"><div style="background:#fff7ed; padding:20px; margin:15px 0; border:2px solid orange;"><h4>Student Record</h4><input id="res-name" placeholder="Name"><div style="display:flex; gap:10px"><input type="number" id="res-marks" placeholder="Marks"><input type="number" id="res-rank" placeholder="Rank"></div><input id="res-link" placeholder="Copy Link"><input id="res-pass" placeholder="Password"><button class="btn-gold" onclick="addResRecord()">+ Add Record</button><p id="res-count">Records: 0</p></div><button class="btn-gold" onclick="publishOfflineResult()">Publish All</button></div></div>
    
    <div id="adm-create-test" style="display:none"><div class="form-box" style="margin:0; max-width:100%"><h3>Create Test</h3><input id="t-title" placeholder="Title"><input type="number" id="t-dur" placeholder="Mins"><input id="t-code" placeholder="Password"><textarea id="t-inst" placeholder="Instructions"></textarea><div style="background:#f0f9ff; padding:20px; margin:20px 0; border:2px solid #bae6fd;"><h4>Add Question</h4><textarea id="q-text" placeholder="Text"></textarea><p>Image:</p><input type="file" id="q-img-file" accept="image/*"><img id="q-img-preview" style="height:80px; display:none"><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px"><input id="op0" placeholder="A"><input id="op1" placeholder="B"><input id="op2" placeholder="C"><input id="op3" placeholder="D"></div><div style="display:flex; gap:10px; margin-top:10px"><select id="q-corr"><option value="0">Correct: A</option><option value="1">Correct: B</option><option value="2">Correct: C</option><option value="3">Correct: D</option></select><input type="number" id="q-mark" value="2" placeholder="+"><input type="number" id="q-neg" value="0.5" placeholder="-"></div><button class="btn-gold" style="margin-top:10px" onclick="addDraftQ()">+ Add Question</button><p id="q-count">Questions: 0</p></div><button class="btn-gold" style="width:100%" onclick="publishTest()">PUBLISH TEST</button></div></div>
</div>

<div id="result-modal" class="modal-overlay">
    <div class="modal-box">
        <h2 style="color:var(--primary)">Test Submitted!</h2>
        <div style="width:300px; height:300px; margin:auto;"><canvas id="resultChart"></canvas></div>
        <h3 id="modal-score" style="margin:20px 0;"></h3>
        <div id="modal-feedback" class="blink-anim" style="background:var(--gold); color:var(--primary); padding:15px; border-radius:10px; font-weight:bold; font-size:1.1rem;"></div>
        <button class="btn-gold" style="margin-top:20px;" onclick="location.reload()">Close</button>
    </div>
</div>

<footer>&copy; [arcclasses2025] All Rights Reserved</footer>

<script>
    // --- STATE ---
    let user = JSON.parse(localStorage.getItem('arc_user'));
    let draftQs=[], qImgBase64="", draftRecs=[], mImgBase64="", bImgBase64="", allMats=[];
    let currentTest=null, studentAnswers=[], visitedQs=[], currentQIdx=0, examInterval;

    // --- INIT ---
    fetch('/api/announcement').then(r=>r.json()).then(d=>document.getElementById('announce-bar').innerText="üì¢ "+d.text);
    loadBlogs();
    if(user) {
        document.getElementById('login-nav').style.display='none'; document.getElementById('logout-btn').style.display='inline';
        if(user.email==='admin@arc.com') document.getElementById('teacher-nav').style.display='inline';
    }

    // --- NAV ---
    function show(id) {
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector('nav').style.display = (id==='exam-ui')?'none':'flex';
        if(id==='notes') loadMaterials(); if(id==='tests') loadTestsList(); if(id==='results') loadResults();
    }
    function showAdminTab(id) {
        ['students','online-res','create-test','upload-mat','upload-res','announce','create-blog','manage'].forEach(t=>document.getElementById('adm-'+t).style.display='none');
        document.getElementById('adm-'+id).style.display='block';
        if(id==='students') loadStudents(); if(id==='online-res') loadOnlineResults(); if(id==='manage') loadManageList();
    }

    // --- AUTH ---
    function toggleReg(){ const b=document.getElementById('reg-box'); b.style.display=b.style.display==='none'?'block':'none'; }
    async function handleReg(){
        const name=document.getElementById('r-name').value; const prefix=document.getElementById('r-prefix').value; const pass=document.getElementById('r-pass').value;
        if(!prefix) return alert("Prefix needed");
        const res=await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,emailPart:prefix,password:pass})});
        if((await res.json()).success){ alert("Registered!"); toggleReg(); } else alert("Taken");
    }
    async function handleLogin(){
        const email=document.getElementById('l-email').value; const pass=document.getElementById('l-pass').value;
        if(email==='admin@arc.com' && pass==='admin123'){ localStorage.setItem('arc_user',JSON.stringify({email,isAdmin:true})); location.reload(); return; }
        const res=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pass})});
        const data=await res.json();
        if(data.success){ localStorage.setItem('arc_user',JSON.stringify({email:data.email,name:data.name})); location.reload(); } else alert("Invalid");
    }
    function logout(){ localStorage.removeItem('arc_user'); location.reload(); }

    // --- TEACHER ---
    async function updateAnnouncement(){ await fetch('/api/admin/announcement',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:document.getElementById('ann-text').value})}); alert("Updated!"); location.reload(); }
    async function loadStudents(){ const d=await (await fetch('/api/admin/students')).json(); document.getElementById('student-table').innerHTML=`<tr><th>Name</th><th>Email</th><th>Password</th></tr>`+d.map(s=>`<tr><td>${s.name}</td><td>${s.email}</td><td>${s.password}</td></tr>`).join(''); }
    async function loadOnlineResults(){ const d=await (await fetch('/api/admin/results/online')).json(); document.getElementById('online-res-table').innerHTML=`<tr><th>Date</th><th>Test</th><th>Student</th><th>Score</th></tr>`+d.map(r=>`<tr><td>${new Date(r.date).toLocaleDateString()}</td><td>${r.testTitle}</td><td>${r.studentName}<br>${r.studentEmail}</td><td>${r.score}/${r.totalMarks} (${r.percentage}%)</td></tr>`).join(''); }
    
    // File Readers
    document.getElementById('m-img-file').addEventListener('change',function(){ const r=new FileReader(); r.onload=e=>mImgBase64=e.target.result; r.readAsDataURL(this.files[0]); });
    document.getElementById('b-img-file').addEventListener('change',function(){ const r=new FileReader(); r.onload=e=>bImgBase64=e.target.result; r.readAsDataURL(this.files[0]); });
    document.getElementById('q-img-file').addEventListener('change',function(){ const r=new FileReader(); r.onload=e=>{qImgBase64=e.target.result; document.getElementById('q-img-preview').src=qImgBase64; document.getElementById('q-img-preview').style.display='block';}; r.readAsDataURL(this.files[0]); });

    // Creators
    async function uploadMaterial(){ await fetch('/api/admin/material',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:document.getElementById('m-title').value, description:document.getElementById('m-desc').value, link:document.getElementById('m-link').value, accessCode:document.getElementById('m-code').value, image:mImgBase64, type:'Book'})}); alert("Uploaded!"); mImgBase64=""; }
    async function createBlog(){ await fetch('/api/admin/blog',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:document.getElementById('b-title').value, content:document.getElementById('b-content').value, image:bImgBase64, hColor:document.getElementById('b-h-color').value, pColor:document.getElementById('b-p-color').value})}); alert("Published!"); bImgBase64=""; }
    function addResRecord(){ draftRecs.push({studentName:document.getElementById('res-name').value, marks:document.getElementById('res-marks').value, rank:document.getElementById('res-rank').value, copyLink:document.getElementById('res-link').value, accessCode:document.getElementById('res-pass').value}); document.getElementById('res-count').innerText=`Records: ${draftRecs.length}`; }
    async function publishOfflineResult(){ await fetch('/api/admin/offline-result',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:document.getElementById('off-title').value, records:draftRecs})}); alert("Published!"); draftRecs=[]; }
    function addDraftQ(){ draftQs.push({text:document.getElementById('q-text').value, image:qImgBase64, options:[0,1,2,3].map(i=>document.getElementById('op'+i).value), correct:parseInt(document.getElementById('q-corr').value), marks:parseFloat(document.getElementById('q-mark').value), negative:parseFloat(document.getElementById('q-neg').value)}); document.getElementById('q-count').innerText=`Questions: ${draftQs.length}`; document.getElementById('q-text').value=""; qImgBase64=""; document.getElementById('q-img-preview').style.display='none'; }
    async function publishTest(){ await fetch('/api/admin/test',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:document.getElementById('t-title').value, duration:document.getElementById('t-dur').value, accessCode:document.getElementById('t-code').value, instructions:document.getElementById('t-inst').value, questions:draftQs})}); alert("Published!"); draftQs=[]; location.reload(); }
    
    // Manage
    async function loadManageList(){
        const [m,t,b] = await Promise.all([fetch('/api/materials'),fetch('/api/tests'),fetch('/api/blogs')]);
        const mats=await m.json(); const tests=await t.json(); const blogs=await b.json();
        let h=`<h4>Tests</h4>`+tests.map(x=>`<div>${x.title} <button class="btn-red" onclick="del('test','${x._id}')">X</button></div>`).join('');
        h+=`<h4>Books</h4>`+mats.map(x=>`<div>${x.title} <button class="btn-red" onclick="del('material','${x._id}')">X</button></div>`).join('');
        h+=`<h4>Blogs</h4>`+blogs.map(x=>`<div>${x.title} <button class="btn-red" onclick="del('blog','${x._id}')">X</button></div>`).join('');
        document.getElementById('manage-list').innerHTML=h;
    }
    async function del(type,id){ if(confirm("Delete?")) await fetch(`/api/admin/${type}/${id}`,{method:'DELETE'}); loadManageList(); }

    // --- STUDENT ---
    async function loadBlogs(){ 
        const d=await (await fetch('/api/blogs')).json(); 
        document.getElementById('blog-container').innerHTML=d.map((b,i)=>`
            <div class="card" style="border-top:5px solid ${b.hColor}; background:#1e293b;">
                ${b.image ? `<img src="${b.image}" style="width:100%; height:150px; object-fit:cover;">`:''}
                <h3 style="color:${b.hColor}">${b.title}</h3>
                <div id="btxt-${i}" class="blog-text" style="color:${b.pColor}">${b.content}</div>
                <button style="color:${b.hColor}; background:none; border:none; margin-top:10px; cursor:pointer;" onclick="document.getElementById('btxt-${i}').classList.toggle('expanded')">Read More</button>
            </div>`).join('');
    }
    async function loadMaterials(){ allMats=await (await fetch('/api/materials')).json(); renderMat(allMats); }
    function renderMat(l){ document.getElementById('mat-list').innerHTML=l.map(m=>`<div class="card" onclick="unlockMat('${m._id}')"><img src="${m.image||'https://via.placeholder.com/200'}" class="book-cover"><h3>${m.title}</h3><p>${m.description||''}</p><button class="btn-gold" style="width:100%">Open</button></div>`).join(''); }
    function filterNotes(){ const q=document.getElementById('home-search').value.toLowerCase(); renderMat(allMats.filter(m=>m.title.toLowerCase().includes(q))); }
    async function unlockMat(id){ const c=prompt("Password:"); if(!c)return; const r=await fetch('/api/material/unlock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,code:c})}); const d=await r.json(); if(d.success)window.open(d.link); else alert("Wrong"); }
    
    async function loadResults(){ const d=await (await fetch('/api/results/offline')).json(); document.getElementById('offline-results-list').innerHTML=d.map(r=>`<div class="card"><h3>${r.title}</h3><table><tr><th>Rank</th><th>Name</th><th>Marks</th><th>Action</th></tr>${r.records.sort((a,b)=>a.rank-b.rank).map(rec=>`<tr><td>#${rec.rank}</td><td>${rec.studentName}</td><td>${rec.marks}</td><td><button class="btn-gold" style="padding:5px" onclick="viewCopy('${r._id}','${rec._id}')">View</button></td></tr>`).join('')}</table></div>`).join(''); }
    async function viewCopy(rid,recid){ const p=prompt("Your Password:"); if(!p)return; const r=await fetch('/api/results/unlock-copy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({resultId:rid,recordId:recid,password:p})}); const d=await r.json(); if(d.success)window.open(d.link); else alert("Wrong"); }

    // --- EXAM ENGINE ---
    async function loadTestsList(){ const d=await (await fetch('/api/tests')).json(); document.getElementById('test-list').innerHTML=d.map(t=>`<div class="card"><h3>${t.title}</h3><p>${t.duration} Mins</p><button class="btn-gold" onclick="startExam('${t._id}')">Start</button></div>`).join(''); }
    async function startExam(id){
        if(!user) return alert("Login first"); const c=prompt("Test Password:"); if(!c)return;
        try {
            const r=await fetch('/api/test/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,code:c,studentEmail:user.email})});
            const d=await r.json();
            if(d.success){ currentTest=d.test; studentAnswers=new Array(currentTest.questions.length).fill(null); visitedQs=new Array(currentTest.questions.length).fill(false); document.getElementById('student-name-display').innerText=user.name; show('exam-ui'); runTimer(currentTest.duration*60); renderQ(0); } else alert(d.message);
        } catch(e) { alert("Connection Error (Check MongoDB IP)"); }
    }
    function runTimer(s){ clearInterval(examInterval); examInterval=setInterval(()=>{ s--; document.getElementById('timer').innerText=`${Math.floor(s/60)}:${s%60}`; if(s<=0){clearInterval(examInterval); submitExam(true);} },1000); }
    function renderQ(i){ currentQIdx=i; visitedQs[i]=true; const q=currentTest.questions[i]; document.getElementById('q-num').innerText=i+1; document.getElementById('q-text').innerText=q.text; document.getElementById('q-marks').innerText=q.marks; document.getElementById('q-neg').innerText=q.negative; const img=document.getElementById('q-image-display'); if(q.image){img.src=q.image; img.style.display='block';}else{img.style.display='none';} document.getElementById('q-options').innerHTML=q.options.map((o,idx)=>`<label class="option-label"><input type="radio" name="opt" value="${idx}" ${studentAnswers[i]===idx?'checked':''}> ${o}</label>`).join(''); renderPalette(); }
    function saveAndNext(){ const s=document.querySelector('input[name="opt"]:checked'); studentAnswers[currentQIdx]=s?parseInt(s.value):null; renderPalette(); navQ(1); }
    function clearResponse(){ const s=document.querySelector('input[name="opt"]:checked'); if(s)s.checked=false; studentAnswers[currentQIdx]=null; renderPalette(); }
    function navQ(d){ const n=currentQIdx+d; if(n>=0 && n<currentTest.questions.length) renderQ(n); }
    function renderPalette(){ document.getElementById('palette').innerHTML=studentAnswers.map((a,i)=>{ let c=a!==null?'answered':(visitedQs[i]?'visited':''); if(i===currentQIdx)c+=' active'; return `<div class="p-btn ${c}" onclick="renderQ(${i})">${i+1}</div>`; }).join(''); }
    
    async function submitExam(force=false){
        if(!force && !confirm("Submit?")) return; clearInterval(examInterval);
        const res=await fetch('/api/test/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({testId:currentTest._id,answers:studentAnswers,studentName:user.name,studentEmail:user.email})});
        const r=await res.json();
        if(r.success){
            document.getElementById('exam-ui').style.display='none'; document.getElementById('result-modal').style.display='flex';
            document.getElementById('modal-score').innerHTML=`Score: ${r.score}/${r.totalMarks} (${r.percentage}%) <br> Rank: #${r.rank}`;
            document.getElementById('modal-feedback').innerText=r.feedback;
            new Chart(document.getElementById('resultChart'),{type:'pie',data:{labels:['Correct','Wrong','Skipped'],datasets:[{data:[r.stats.correct,r.stats.wrong,r.stats.skipped],backgroundColor:['#22c55e','#ef4444','#a855f7']}]}});
        } else alert("Error submitting");
    }
    
    // Heartbeat
    setInterval(()=>fetch('/api/tests').catch(e=>{}), 2*60*1000);
</script>
</body>
</html>