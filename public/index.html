<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARC CLASSES</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0f172a; --gold: #fbbf24; --light: #f8fafc; --red: #ef4444; --green: #22c55e; }
        
        /* 1. SCROLL FIXES */
        html, body { 
            overscroll-behavior-y: none; 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--light); 
            margin: 0; 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh; 
        }
        body.modal-open { overflow: hidden; height: 100vh; }

        nav { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 1.5rem; font-weight: 900; background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); background-size: 400%; -webkit-background-clip: text; background-clip: text; color: transparent; animation: rainbow 8s linear infinite; cursor: pointer; }
        @keyframes rainbow { 0% { background-position: 0%; } 100% { background-position: 400%; } }

        .menu-toggle { display: none; color: white; font-size: 1.8rem; cursor: pointer; }
        .menu { display: flex; align-items: center; gap: 20px; }
        .menu a { color: white; text-decoration: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .menu a:hover { color: var(--gold); }
        @media (max-width: 768px) {
            .menu { display: none; flex-direction: column; position: absolute; top: 60px; left: 0; width: 100%; background: var(--primary); padding: 20px 0; border-top: 1px solid #333; }
            .menu.active { display: flex; }
            .menu-toggle { display: block; }
        }

        .section { display: none; padding: 20px; max-width: 1200px; margin: auto; width: 100%; box-sizing: border-box; flex: 1; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; display: flex; flex-direction: column; cursor: pointer; transition: 0.2s; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        #lib-cats.grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } 

        input, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        /* Rich Text Inputs */
        .editor { min-height: 50px; border: 1px solid #ccc; padding: 10px; border-radius: 6px; margin: 5px 0; background: white; outline: none; }
        .editor:focus { border-color: var(--primary); }
        .toolbar button { cursor: pointer; padding: 5px 8px; font-weight: bold; border: 1px solid #ccc; background: #fff; margin-right: 2px; border-radius: 4px; }
        .toolbar button:hover { background: #eee; }

        .btn { padding: 10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; transition: 0.2s; white-space: nowrap; }
        .btn-gold { background: var(--gold); color: var(--primary); }
        .btn-red { background: var(--red); color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }

        /* MODALS */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:flex-start; z-index: 2000; padding: 10px; box-sizing: border-box; overflow-y: auto; overscroll-behavior: contain; }
        .modal-content { background:white; width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 12px; position: relative; margin-top: 20px; margin-bottom: 20px; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .close-corner { position: absolute; top: 10px; right: 10px; background: #f1f5f9; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; color: #333; font-weight: bold; z-index: 20; border: 1px solid #ddd; }

        .exam-layout { display: flex; gap: 20px; height: calc(100vh - 140px); flex-direction: column; }
        @media(min-width: 900px) { .exam-layout { flex-direction: row; } }
        .question-panel { flex: 3; background: white; padding: 15px; border-radius: 12px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        .palette-panel { flex: 1; background: white; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; max-height: 200px; overflow-y: auto; }
        @media(min-width: 900px) { .palette-panel { max-height: none; } }
        
        /* Creator Palette */
        .creator-grid { display: grid; grid-template-columns: 1fr 200px; gap: 20px; }
        @media(max-width: 768px) { .creator-grid { grid-template-columns: 1fr; } }

        .p-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 5px; }
        .p-btn { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border: 1px solid #ddd; cursor: pointer; border-radius: 50%; font-weight: bold; font-size: 0.9rem; }
        .p-btn.done { background: var(--green); color: white; border-color: var(--green); }
        .p-btn.active { border: 2px solid var(--primary); }
        
        .table-container { overflow-x: auto; margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }
        
        footer { background: var(--primary); color: white; text-align: center; padding: 20px; margin-top: auto; border-top: 4px solid var(--gold); }
    </style>
</head>
<body>

<template id="rt-toolbar">
    <div class="toolbar" style="background:#f1f5f9; padding:5px; border:1px solid #ccc; border-bottom:none; border-radius: 6px 6px 0 0; display:flex; gap:5px; flex-wrap:wrap;">
        <button type="button" onclick="exec('bold')"><b>B</b></button>
        <button type="button" onclick="exec('italic')"><i>I</i></button>
        <button type="button" onclick="exec('underline')"><u>U</u></button>
        <button type="button" onclick="exec('subscript')">X‚ÇÇ</button>
        <button type="button" onclick="exec('superscript')">X¬≤</button>
        <button type="button" onclick="document.execCommand('foreColor', false, 'red')" style="color:red">A</button>
        <button type="button" onclick="document.execCommand('foreColor', false, 'black')">A</button>
        <button type="button" onclick="insertText(' ‚Üí ')">‚Üí</button>
        <button type="button" onclick="insertText(' ‚áå ')">‚áå</button>
        <button type="button" onclick="insertText(' Œî ')">Œî</button>
        <button type="button" onclick="insertText(' ¬∞ ')">¬∞</button>
    </div>
</template>

<nav>
    <div class="logo" onclick="show('home')">ARC CLASSES</div>
    <div class="menu-toggle" onclick="toggleMenu()">‚ò∞</div>
    <div class="menu" id="nav-menu">
        <a onclick="show('home')">Home</a>
        <a onclick="show('library')">Library</a>
        <a onclick="show('tests')">Tests</a>
        <a onclick="show('live')"><span style="color:red">‚óè</span> Live</a>
        <a onclick="show('results')">Results</a>
        <a onclick="show('login')" id="nav-login">Login</a>
        <a onclick="show('admin')" id="nav-admin" style="display:none; background: var(--red); padding: 5px 10px; border-radius: 4px;">TEACHER</a>
        <a onclick="logout()" id="nav-logout" style="display:none">Logout</a>
    </div>
</nav>

<div id="home" class="section active">
    <div style="text-align:center; padding: 40px 10px;">
        <h1 style="color:var(--primary);">Master Chemistry</h1>
        <button class="btn btn-gold" onclick="show('tests')">Start Practice</button>
    </div>
    <h3 style="margin-left: 10px;">Latest Blogs</h3>
    <div id="blog-grid" class="grid"></div>
</div>

<div id="login" class="section">
    <div style="width:100%; max-width:400px; margin:auto; background:white; padding:30px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="text-align:center;">Login</h2>
        <input id="l-email" placeholder="Email / Admin ID">
        <input id="l-pass" type="password" placeholder="Password">
        <button class="btn btn-gold" style="width:100%" onclick="doLogin()">Login</button>
        <p style="text-align:center; cursor:pointer; color:blue;" onclick="document.getElementById('reg-box').style.display='block'; document.getElementById('login').style.display='none';">New Student? Register</p>
    </div>
</div>

<div id="reg-box" class="section" style="display:none;">
    <div style="width:100%; max-width:400px; margin:auto; background:white; padding:30px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="text-align:center;">Register</h2>
        <input id="r-name" placeholder="Full Name">
        <div style="display:flex; align-items:center; border:1px solid #ccc; border-radius:6px; background:white; margin:10px 0;">
            <input id="r-prefix" placeholder="username" style="border:none; margin:0;"> 
            <div style="padding:10px; background:#f1f5f9;">@arcstudent.com</div>
        </div>
        <input id="r-pass" type="password" placeholder="Password">
        <button class="btn btn-gold" style="width:100%" onclick="doReg()">Register</button>
        <p style="text-align:center; cursor:pointer; color:blue;" onclick="show('login'); document.getElementById('reg-box').style.display='none';">Back to Login</p>
    </div>
</div>

<div id="admin" class="section">
    <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
        <button class="btn btn-gold btn-small" onclick="initCreateTest()">‚ûï Test Maker</button>
        <button class="btn btn-gold btn-small" onclick="showAdm('blog')">‚úçÔ∏è Blog</button>
        <button class="btn btn-gold btn-small" onclick="showAdm('offline')">üìä Offline Marks</button>
        <button class="btn btn-gold btn-small" onclick="showAdm('upload')">üìÇ Upload File</button>
        <button class="btn btn-red btn-small" onclick="showAdm('manage')">üõ†Ô∏è Manage Content</button>
    </div>
    <div id="adm-content" style="background:white; padding:15px; border-radius:10px; border:1px solid #ddd; min-height:300px;"></div>
</div>

<div id="library" class="section">
    <h2>üìö Library</h2>
    <div id="lib-cats" class="grid">
        <div class="card" onclick="loadLib('11th Class')"><b>11th Class</b></div>
        <div class="card" onclick="loadLib('12th Class')"><b>12th Class</b></div>
        <div class="card" onclick="loadLib('Organic')"><b>Organic</b></div>
        <div class="card" onclick="loadLib('Physical')"><b>Physical</b></div>
        <div class="card" onclick="loadLib('Inorganic')"><b>Inorganic</b></div>
    </div>
    <button id="lib-back" class="btn btn-red" style="display:none; margin-bottom:15px;" onclick="resetLib()">Back</button>
    <div id="lib-content" class="grid"></div>
</div>

<div id="tests" class="section"><h2>üìù Practice Tests</h2><div id="test-list" class="grid"></div></div>
<div id="live" class="section"><h2>üî¥ Live Tests</h2><div id="live-list" class="grid"></div></div>

<div id="exam" class="section" style="padding:10px; height: 100vh;">
    <div class="exam-layout">
        <div class="question-panel">
            <div id="mobile-timer" style="background:#fee2e2; color:red; text-align:center; padding:5px; border:1px solid red; border-radius:5px; margin-bottom:10px; font-weight:bold;">00:00</div>
            <div style="display:flex; justify-content:space-between;">
                <h3 id="q-no">Q1</h3><span id="q-marks" style="color:green; font-weight:bold;"></span>
            </div>
            <div id="q-text" style="font-size:1.1rem; margin-bottom:15px;"></div>
            <img id="q-img" style="max-height:200px; display:none; margin:10px auto;">
            <div id="q-opts" style="margin-top:10px;"></div>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content: space-between;">
                <button class="btn btn-red" onclick="clearAns()">Clear</button>
                <button class="btn btn-gold" onclick="saveNext()">Save & Next ‚û°</button>
            </div>
        </div>
        <div class="palette-panel">
            <div id="palette" class="p-grid"></div>
            <button class="btn btn-red" style="width:100%; margin-top:20px;" onclick="submitTest()">SUBMIT TEST</button>
        </div>
    </div>
</div>

<div id="results" class="section">
    <h2>üèÜ Results</h2>
    <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="btn btn-gold btn-small" onclick="loadResults('online')">Online</button>
        <button class="btn btn-gold btn-small" onclick="loadOfflineResults()">Offline</button>
    </div>
    <div id="result-list" class="table-container"></div>
</div>

<div id="review-modal" class="modal">
    <div class="modal-content">
        <div class="close-corner" onclick="closeModal('review-modal')">&times;</div>
        <h2>Analysis</h2>
        <div id="review-stats" style="text-align:center; font-weight:bold; margin-bottom:15px;"></div>
        <div id="review-body"></div>
    </div>
</div>

<div id="blog-modal" class="modal">
    <div class="modal-content">
        <div class="close-corner" onclick="closeModal('blog-modal')">&times;</div>
        <h2 id="bm-title"></h2>
        <div id="bm-content"></div>
    </div>
</div>

<script>
    // --- RICH TEXT HELPERS ---
    function exec(cmd) { document.execCommand(cmd, false, null); }
    function insertText(text) { 
        const sel = window.getSelection();
        if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.insertNode(document.createTextNode(text));
        }
    }
    function getToolbar() { return document.getElementById('rt-toolbar').innerHTML; }

    // --- GLOBAL VARS ---
    let user = JSON.parse(localStorage.getItem('arc_user'));
    let currentTest=null, answers=[], timer=null, qIndex=0, draftQ=[], offlineDraft=[];
    let editingTestId = null, editingQIndex = null, tempImg = "", tempSolImg = "";
    let allMats = [];

    // --- INIT ---
    window.onload = function() {
        if(user) {
            document.getElementById('nav-login').style.display='none';
            document.getElementById('nav-logout').style.display='block';
            if(user.role==='admin') document.getElementById('nav-admin').style.display='block';
        }
        show('home'); loadBlogs(); loadMaterials();
    };

    function show(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('nav-menu').classList.remove('active');
        if(id === 'tests') loadTests(false);
        if(id === 'live') loadTests(true);
    }
    
    function toggleMenu() { document.getElementById('nav-menu').classList.toggle('active'); }
    function closeModal(id) { document.getElementById(id).style.display='none'; document.body.classList.remove('modal-open'); }
    function logout() { localStorage.removeItem('arc_user'); location.reload(); }

    // --- AUTH ---
    async function doLogin() {
        const email = document.getElementById('l-email').value;
        const password = document.getElementById('l-pass').value;
        const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, password}) });
        const data = await res.json();
        if(data.success) { localStorage.setItem('arc_user', JSON.stringify(data)); location.reload(); } else alert("Failed");
    }
    async function doReg() {
        const name = document.getElementById('r-name').value;
        const emailPart = document.getElementById('r-prefix').value;
        const password = document.getElementById('r-pass').value;
        const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, emailPart, password}) });
        const data = await res.json();
        if(data.success) { alert("Registered!"); show('login'); } else alert(data.message);
    }

    // --- ADMIN PANEL ---
    function showAdm(tab) {
        const c = document.getElementById('adm-content');
        if(tab === 'create-test') {
            c.innerHTML = `
                <div class="creator-grid">
                    <div>
                        <h3>Test Details</h3>
                        <input id="t-title" placeholder="Test Title">
                        <div style="display:flex; gap:10px;">
                            <input id="t-dur" type="number" placeholder="Duration (Mins)">
                            <input id="t-code" placeholder="Password (Optional)">
                        </div>
                        <label><input type="checkbox" id="t-live"> Live Test?</label>
                        <div style="margin:5px 0;">Start Time: <input type="datetime-local" id="t-start"></div>
                        <hr>
                        <h4>Question Editor</h4>
                        ${getToolbar()}<div id="q-editor" class="editor" contenteditable="true" placeholder="Question Text"></div>
                        <input type="file" onchange="encodeImg(this, 'q-prev')"><img id="q-prev" style="height:50px; display:none;">
                        
                        <div style="margin-top:10px;"><b>Options</b></div>
                        <div style="display:grid; gap:5px;">
                            ${[0,1,2,3].map(i => `<div>${getToolbar()}<div id="op${i}" class="editor" contenteditable="true" placeholder="Option"></div></div>`).join('')}
                        </div>
                        Correct: <select id="q-corr"><option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option></select>
                        
                        <div style="margin-top:10px;"><b>Solution (Hidden during test)</b></div>
                        ${getToolbar()}<div id="q-sol-editor" class="editor" contenteditable="true" placeholder="Solution Text"></div>
                        <input type="file" onchange="encodeImg(this, 'sol-prev', true)"><img id="sol-prev" style="height:50px; display:none;">
                        
                        <button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="saveDraftQ()">Save Question</button>
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:10px;">
                        <h4>Questions (<span id="q-count">0</span>)</h4>
                        <div id="create-palette" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                        <button class="btn btn-red" style="width:100%; margin-top:20px;" onclick="pubTest()">PUBLISH TEST</button>
                    </div>
                </div>`;
            renderCreatePalette();
        } else if (tab === 'blog') {
            c.innerHTML = `<h3>Write Blog</h3><input id="b-title" placeholder="Title"><input type="file" onchange="encodeImg(this, 'b-prev')"><img id="b-prev" style="height:100px; display:none;">${getToolbar()}<div id="b-content" class="editor" contenteditable="true" style="min-height:200px"></div><button class="btn btn-gold" onclick="postBlog()" style="margin-top:10px;">Post Blog</button>`;
        } else if (tab === 'offline') {
            c.innerHTML = `<h3>Offline Marks Entry</h3><input id="off-title" placeholder="Test Title"><div style="display:grid; grid-template-columns: 2fr 1fr 1fr 2fr auto; gap:5px;"><input id="off-name" placeholder="Name"><input id="off-total" placeholder="Total"><input id="off-obt" placeholder="Obtained"><input id="off-link" placeholder="Sheet Link"><button class="btn btn-gold" onclick="addOfflineStudent()">+</button></div><div class="table-container"><table><thead><tr><th>Name</th><th>Marks</th><th>Link</th><th>Del</th></tr></thead><tbody id="off-body"></tbody></table></div><button class="btn btn-red" style="width:100%" onclick="postOffline()">Upload Result</button>`;
            offlineDraft = []; renderOfflineDraft();
        } else if (tab === 'manage') {
            c.innerHTML = `<h3>Manage Content</h3><div style="display:flex; gap:10px; margin-bottom:10px;"><button class="btn btn-gold btn-small" onclick="loadManage('test')">Tests</button><button class="btn btn-gold btn-small" onclick="loadManage('blog')">Blogs</button><button class="btn btn-gold btn-small" onclick="loadManage('student')">Students</button></div><div id="manage-area" class="table-container">Select a category.</div>`;
        } else if (tab === 'upload') {
            c.innerHTML = `<h3>Upload Material</h3><input id="m-title" placeholder="Title"><input id="m-link" placeholder="PDF Link"><input id="m-img" placeholder="Image URL"><select id="m-cat"><option>11th Class</option><option>12th Class</option><option>Organic</option><option>Physical</option><option>Inorganic</option></select><button class="btn btn-gold" style="width:100%; margin-top:10px;" onclick="uploadMat()">Upload</button>`;
        }
    }

    // --- TEST CREATION LOGIC ---
    function initCreateTest(id=null) { editingTestId = id; draftQ = []; showAdm('create-test'); if(id) loadTestForEdit(id); }
    async function loadTestForEdit(id) {
        const res = await fetch(`/api/admin/test/${id}`); const t = await res.json();
        document.getElementById('t-title').value = t.title;
        document.getElementById('t-dur').value = t.duration;
        document.getElementById('t-code').value = t.accessCode;
        document.getElementById('t-live').checked = t.isLive;
        document.getElementById('t-start').value = t.startTime ? t.startTime.slice(0,16) : "";
        draftQ = t.questions; renderCreatePalette();
    }
    
    function saveDraftQ() {
        const qData = {
            text: document.getElementById('q-editor').innerHTML,
            solution: document.getElementById('q-sol-editor').innerHTML,
            options: [0,1,2,3].map(i => document.getElementById('op'+i).innerHTML),
            correct: parseInt(document.getElementById('q-corr').value),
            image: tempImg, solutionImage: tempSolImg,
            marks: 4, negative: 1
        };
        if(editingQIndex !== null) { draftQ[editingQIndex] = qData; editingQIndex = null; } else draftQ.push(qData);
        // Clear inputs
        document.getElementById('q-editor').innerHTML=""; document.getElementById('q-sol-editor').innerHTML="";
        [0,1,2,3].forEach(i=>document.getElementById('op'+i).innerHTML="");
        tempImg=""; tempSolImg=""; document.getElementById('q-prev').style.display='none'; document.getElementById('sol-prev').style.display='none';
        renderCreatePalette();
    }

    function renderCreatePalette() {
        document.getElementById('q-count').innerText = draftQ.length;
        document.getElementById('create-palette').innerHTML = draftQ.map((q, i) => `<div onclick="editQuestion(${i})" style="width:30px; height:30px; background:#ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:0.8rem; border-radius:4px;">Q${i+1}</div>`).join('');
    }

    function editQuestion(i) {
        editingQIndex = i; const q = draftQ[i];
        document.getElementById('q-editor').innerHTML = q.text;
        document.getElementById('q-sol-editor').innerHTML = q.solution || "";
        q.options.forEach((o, idx) => document.getElementById('op'+idx).innerHTML = o);
        document.getElementById('q-corr').value = q.correct;
    }

    async function pubTest() {
        const body = {
            _id: editingTestId,
            title: document.getElementById('t-title').value,
            duration: parseInt(document.getElementById('t-dur').value),
            accessCode: document.getElementById('t-code').value,
            isLive: document.getElementById('t-live').checked,
            startTime: document.getElementById('t-start').value || null,
            questions: draftQ
        };
        await fetch('/api/admin/test', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        alert("Published!"); show('admin');
    }

    // --- OFFLINE & MANAGE ---
    function addOfflineStudent() {
        offlineDraft.push({
            studentName: document.getElementById('off-name').value,
            totalMarks: document.getElementById('off-total').value,
            obtainedMarks: document.getElementById('off-obt').value,
            copyLink: document.getElementById('off-link').value
        });
        renderOfflineDraft();
    }
    function renderOfflineDraft() {
        document.getElementById('off-body').innerHTML = offlineDraft.map((s,i) => `<tr><td>${s.studentName}</td><td>${s.obtainedMarks}/${s.totalMarks}</td><td>${s.copyLink?'<a href="#">Link</a>':'-'}</td><td><button onclick="offlineDraft.splice(${i},1);renderOfflineDraft()">X</button></td></tr>`).join('');
    }
    async function postOffline() {
        await fetch('/api/admin/offline-result', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title: document.getElementById('off-title').value, records: offlineDraft }) });
        alert("Uploaded"); show('admin');
    }

    async function loadManage(type) {
        let endpoint = type==='test' ? '/api/tests' : (type==='blog' ? '/api/blogs' : '/api/admin/students');
        const res = await fetch(endpoint); const data = await res.json();
        document.getElementById('manage-area').innerHTML = `<table><tr><th>Title/Name</th><th>Action</th></tr>${data.map(i => `<tr><td>${i.title || i.name}</td><td>${type==='test' ? `<button onclick="initCreateTest('${i._id}')">Edit</button> ` : ''}<button style="color:red" onclick="delItem('${type}','${i._id}')">Delete</button></td></tr>`).join('')}</table>`;
    }
    async function delItem(type, id) { if(confirm("Delete?")) { await fetch(`/api/admin/${type}/${id}`, { method:'DELETE' }); loadManage(type); } }

    // --- BLOG & MATERIAL ---
    function encodeImg(input, prevId, isSol=false) {
        if(input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if(isSol) tempSolImg = e.target.result; else tempImg = e.target.result;
                const img = document.getElementById(prevId); img.src=e.target.result; img.style.display='block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    async function postBlog() { await fetch('/api/admin/blog', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title:document.getElementById('b-title').value, content:document.getElementById('b-content').innerHTML, image:tempImg }) }); alert("Posted"); show('home'); }
    async function loadBlogs() { const res=await fetch('/api/blogs'); const d=await res.json(); document.getElementById('blog-grid').innerHTML = d.map(b => `<div class="card" onclick="viewBlog('${b._id}')"><h4>${b.title}</h4></div>`).join(''); }

    // --- EXAM ENGINE ---
    async function loadTests(live) {
        const res = await fetch('/api/tests'); const data = await res.json();
        const now = new Date();
        const list = data.filter(t => live ? (t.isLive && new Date(t.endTime) > now) : (!t.isLive || new Date(t.endTime) <= now));
        document.getElementById(live?'live-list':'test-list').innerHTML = list.map(t => `<div class="card"><h3>${t.title}</h3><p>${t.duration} Mins</p><button class="btn btn-gold" onclick="startTest('${t._id}', ${t.accessCode?1:0})">Start</button></div>`).join('');
    }

    async function startTest(id, locked) {
        if(locked) { const p=prompt("Password:"); if(!p) return; }
        const res = await fetch('/api/test/start', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, studentEmail:user.email}) });
        const d = await res.json();
        if(d.success) {
            currentTest = d.test; answers = new Array(currentTest.questions.length).fill(null); qIndex=0;
            // Auto calculate end time logic is handled by backend for verification, but frontend needs a target
            const targetTime = currentTest.isLive ? new Date(currentTest.endTime).getTime() : Date.now() + (currentTest.duration * 60000);
            show('exam'); renderQ(); startTimer(targetTime);
        } else alert(d.message);
    }

    function renderQ() {
        const q = currentTest.questions[qIndex];
        document.getElementById('q-no').innerText = `Q${qIndex+1}`;
        document.getElementById('q-text').innerHTML = q.text;
        document.getElementById('q-opts').innerHTML = q.options.map((o,i) => `<label style="display:flex; padding:10px; border:1px solid #ddd; margin:5px 0; border-radius:6px;"><input type="radio" name="opt" value="${i}" ${answers[qIndex]===i?'checked':''}> <div style="margin-left:10px;">${o}</div></label>`).join('');
        const img = document.getElementById('q-img');
        if(q.image) { img.src=q.image; img.style.display='block'; } else img.style.display='none';
        document.getElementById('palette').innerHTML = answers.map((a,i) => `<div class="p-btn ${a!==null?'done':''} ${i===qIndex?'active':''}" onclick="qIndex=${i};renderQ()">${i+1}</div>`).join('');
    }
    
    function saveNext() {
        const sel = document.querySelector('input[name="opt"]:checked');
        answers[qIndex] = sel ? parseInt(sel.value) : null;
        if(qIndex < currentTest.questions.length-1) { qIndex++; renderQ(); }
    }

    function startTimer(target) {
        clearInterval(timer);
        timer = setInterval(() => {
            const now = Date.now(); const diff = Math.floor((target - now)/1000);
            if(diff <= 0) { clearInterval(timer); submitTest(); return; }
            const m = Math.floor(diff/60); const s = diff%60;
            document.getElementById('mobile-timer').innerText = `${m}:${s<10?'0'+s:s}`;
        }, 1000);
    }

    async function submitTest() {
        clearInterval(timer);
        const res = await fetch('/api/test/submit', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ testId:currentTest._id, answers, studentName:user.name, studentEmail:user.email }) });
        const d = await res.json();
        if(d.success) { show('results'); viewResult(d.resultId); }
    }

    // --- RESULTS ---
    async function loadResults(type) {
        const res = await fetch('/api/student/results/online', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:user.email}) });
        const d = await res.json();
        document.getElementById('result-list').innerHTML = `<table><tr><th>Test</th><th>Score</th><th>Act</th></tr>${d.results.map(r => `<tr><td>${r.testTitle}</td><td>${r.score}</td><td><button onclick="viewResult('${r._id}')">View</button></td></tr>`).join('')}</table>`;
    }
    
    async function viewResult(id) {
        const res = await fetch('/api/result-details', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({resultId:id}) });
        const d = await res.json();
        document.getElementById('review-stats').innerHTML = `Score: ${d.result.score} | Rank: #${d.rank}`;
        document.getElementById('review-body').innerHTML = d.questions.map((q,i) => `
            <div style="border-bottom:1px solid #eee; padding:10px 0;">
                <div><strong>Q${i+1}:</strong> ${q.text}</div>
                ${q.image ? `<img src="${q.image}" style="height:100px;">` : ''}
                <div style="color:${q.status==='Correct'?'green':'red'}">Your Answer: ${q.studentAnswer!==null?q.options[q.studentAnswer]:'Skipped'}</div>
                <div style="background:#f0fdf4; padding:10px; margin-top:5px; border-radius:5px;">
                    <strong>Correct:</strong> ${q.options[q.correct]}<br>
                    <strong>Solution:</strong> ${q.solution || "No solution provided."}
                    ${q.solutionImage ? `<br><img src="${q.solutionImage}" style="max-height:150px; margin-top:5px;">` : ''}
                </div>
            </div>`).join('');
        document.getElementById('review-modal').style.display='flex';
        document.body.classList.add('modal-open');
    }
    
    async function loadOfflineResults() {
        const res = await fetch('/api/results/offline'); const d = await res.json();
        document.getElementById('result-list').innerHTML = d.map(r => `<h4>${r.title}</h4><table><tr><th>Rank</th><th>Name</th><th>Marks</th><th>Link</th></tr>${r.records.map(s => `<tr><td>#${s.rank}</td><td>${s.studentName}</td><td>${s.obtainedMarks}/${s.totalMarks||'-'}</td><td>${s.copyLink ? `<a href="${s.copyLink}" target="_blank">View</a>` : '-'}</td></tr>`).join('')}</table>`).join('');
    }

    // --- LIBRARY ---
    async function uploadMat() {
        await fetch('/api/admin/material', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ title:document.getElementById('m-title').value, link:document.getElementById('m-link').value, category:document.getElementById('m-cat').value }) });
        alert("Uploaded"); show('admin');
    }
    async function loadMaterials() { const res = await fetch('/api/materials'); allMats = await res.json(); }
    function loadLib(cat) { 
        document.getElementById('lib-cats').style.display='none'; document.getElementById('lib-back').style.display='block';
        document.getElementById('lib-content').innerHTML = allMats.filter(m => m.category===cat).map(m => `<div class="card"><h4>${m.title}</h4><a href="${m.link}" target="_blank" class="btn btn-gold btn-small">Open</a></div>`).join('');
    }
    function resetLib() { document.getElementById('lib-cats').style.display='grid'; document.getElementById('lib-back').style.display='none'; document.getElementById('lib-content').innerHTML=''; }
    
</script>
</body>
</html>