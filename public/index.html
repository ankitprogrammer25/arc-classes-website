<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARC CLASSES</title>
    <style>
        :root { --primary: #0f172a; --gold: #fbbf24; --light: #f8fafc; --red: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; color: #333; }

        /* --- RGB ANIMATED LOGO --- */
        @keyframes rainbow { 
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .logo {
            font-size: 1.8rem;
            font-weight: 900;
            letter-spacing: 2px;
            background: linear-gradient(270deg, #ff0000, #fbbf24, #00ff00, #0000ff, #ff00ff);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            color: transparent;
            animation: rainbow 6s ease infinite;
        }

        nav { background: var(--primary); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .menu a { color: white; margin-left: 20px; text-decoration: none; font-weight: 500; cursor: pointer; transition: 0.3s; }
        .menu a:hover { color: var(--gold); }
        
        .section { display: none; padding: 20px; max-width: 1100px; margin: auto; }
        .section.active { display: block; }
        
        /* CARDS & GRIDS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); }
        .book-cover { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; background: #eee; }
        
        /* FORMS & BUTTONS */
        .form-box { max-width: 500px; margin: 30px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; }
        button:hover { background: #1e293b; }
        .btn-gold { background: var(--gold); color: var(--primary); }
        .btn-red { background: var(--red); color: white; }
        
        /* ANNOUNCEMENTS */
        .marquee { background: var(--gold); color: var(--primary); padding: 10px; font-weight: bold; overflow: hidden; white-space: nowrap; margin-bottom: 20px; }
        
        /* RESULTS TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }

        /* QUOTE SLIDER */
        .quote-box { background: var(--primary); color: white; padding: 40px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .quote-text { font-size: 1.5rem; font-style: italic; }
    </style>
</head>
<body>

<nav>
    <div class="logo">ARC CLASSES</div>
    <div class="menu">
        <a onclick="show('home')">Home</a>
        <a onclick="show('notes')">Books/Notes</a>
        <a onclick="show('tests')">Online Tests</a>
        <a onclick="show('results')">Results</a>
        <a onclick="show('login')" id="login-nav">Login</a>
        <a id="teacher-nav" onclick="show('admin')" style="display:none; color:var(--red)">TEACHER PANEL</a>
        <a onclick="logout()" id="logout-btn" style="display:none">(Logout)</a>
    </div>
</nav>

<div id="home" class="section active">
    <div class="marquee" id="announce-bar">üì¢ IMPORTANT: Check the Results section for the latest Offline Test Marks!</div>

    <div class="quote-box">
        <p class="quote-text" id="quote-display">"Chemistry is the melody you can play on vibrating strings."</p>
    </div>

    <div style="text-align:center;">
        <h2 style="color:var(--primary)">Welcome to Excellence</h2>
        <p>Your gateway to mastering Chemistry.</p>
    </div>
</div>

<div id="notes" class="section">
    <h2>üìö Library (Notes & Books)</h2>
    <div id="mat-list" class="grid">Loading...</div>
</div>

<div id="tests" class="section">
    <h2>üìù Online Tests</h2>
    <div id="test-list" class="grid">Loading...</div>
</div>

<div id="results" class="section">
    <h2>üèÜ Results Board</h2>
    <div id="offline-results-list"></div>
</div>

<div id="login" class="section">
    <div class="form-box">
        <h2>Login</h2>
        <input type="email" id="l-email" placeholder="Email (e.g. name@arcstudent.com)">
        <input type="password" id="l-pass" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <p style="text-align:center; color:blue; cursor:pointer" onclick="toggleReg()">New Student? Register</p>
        <p style="text-align:center; font-size:0.8rem; color:#999">Teacher? (admin@arc.com)</p>
    </div>
    
    <div id="reg-box" class="form-box" style="display:none">
        <h2>Student Registration</h2>
        <p style="color:red; font-size:0.9rem;">‚ö†Ô∏è Please remember your email and password. It is NOT restorable.</p>
        <input type="text" id="r-name" placeholder="Full Name">
        <div style="display:flex; align-items:center; gap:5px;">
            <input type="text" id="r-prefix" placeholder="username" style="text-align:right">
            <span>@arcstudent.com</span>
        </div>
        <input type="password" id="r-pass" placeholder="Create Password">
        <button class="btn-gold" onclick="handleReg()">Register Now</button>
        <button style="background:#ddd; color:#333; margin-top:5px" onclick="toggleReg()">Cancel</button>
    </div>
</div>

<div id="admin" class="section">
    <h2>üë®‚Äçüè´ Teacher Dashboard</h2>
    
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button onclick="showAdminTab('students')">Students</button>
        <button onclick="showAdminTab('manage')">Manage Content</button>
        <button onclick="showAdminTab('create')">Create New</button>
        <button onclick="showAdminTab('off-res')">Upload Results</button>
    </div>

    <div id="adm-students" style="display:none">
        <h3>Registered Students</h3>
        <table id="student-table"></table>
    </div>

    <div id="adm-manage" style="display:none">
        <h3>Delete Tests or Notes</h3>
        <div id="manage-list"></div>
    </div>

    <div id="adm-create" style="display:none">
        <div class="form-box" style="margin:0; max-width:100%">
            <h3>1. Upload Book/Note</h3>
            <input type="text" id="m-title" placeholder="Title">
            <input type="text" id="m-desc" placeholder="Description">
            <input type="text" id="m-link" placeholder="Drive Link">
            <input type="text" id="m-code" placeholder="Password">
            <p>Cover Image:</p>
            <input type="file" id="m-img-file">
            <button onclick="uploadMaterial()">Upload Material</button>
            <hr>
            <h3>2. Create Online Test</h3>
            <input type="text" id="t-title" placeholder="Test Title">
            <input type="number" id="t-dur" placeholder="Duration (Mins)">
            <input type="text" id="t-code" placeholder="Password">
            <textarea id="t-inst" placeholder="Instructions..."></textarea>
            
            <div id="q-builder" style="background:#f0f9ff; padding:10px; margin:10px 0;">
                <h4>Add Question</h4>
                <textarea id="q-text" placeholder="Question Text"></textarea>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
                    <input id="op0" placeholder="Option 1">
                    <input id="op1" placeholder="Option 2">
                    <input id="op2" placeholder="Option 3">
                    <input id="op3" placeholder="Option 4">
                </div>
                <div style="display:flex; gap:5px">
                    <select id="q-corr"><option value="0">Correct: Opt 1</option><option value="1">Correct: Opt 2</option><option value="2">Correct: Opt 3</option><option value="3">Correct: Opt 4</option></select>
                    <input type="number" id="q-mark" placeholder="+Marks" value="2">
                    <input type="number" id="q-neg" placeholder="-Marks" value="0.5">
                </div>
                <button class="btn-gold" onclick="addDraftQ()">+ Add Question</button>
                <p id="q-count">Questions Added: 0</p>
            </div>
            <button onclick="publishTest()">PUBLISH TEST</button>
        </div>
    </div>

    <div id="adm-off-res" style="display:none">
        <div class="form-box" style="margin:0; max-width:100%">
            <h3>Upload Offline Test Result</h3>
            <input type="text" id="off-title" placeholder="Test Name (e.g. Physics Midterm)">
            
            <div id="res-builder" style="background:#fff7ed; padding:10px;">
                <h4>Add Student Record</h4>
                <input id="res-name" placeholder="Student Name">
                <input type="number" id="res-marks" placeholder="Marks">
                <input type="number" id="res-rank" placeholder="Rank">
                <input id="res-link" placeholder="Checked Copy Link (Drive)">
                <input id="res-pass" placeholder="Unique Password for Student">
                <button class="btn-gold" onclick="addResRecord()">+ Add Record</button>
                <p id="res-count">Records: 0</p>
            </div>
            <button onclick="publishOfflineResult()">PUBLISH RESULTS</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let user = JSON.parse(localStorage.getItem('arc_user'));
    let draftQs = [];
    let draftRecs = [];
    let coverImgBase64 = "";

    // --- QUOTES ---
    const quotes = [
        "Chemistry is the study of transformation.",
        "Education is not the filling of a pail, but the lighting of a fire.",
        "Reactions happen when bonds are broken and made.",
        "Be like a proton, always positive."
    ];
    let qIdx = 0;
    setInterval(() => {
        qIdx = (qIdx + 1) % quotes.length;
        document.getElementById('quote-display').innerText = `"${quotes[qIdx]}"`;
    }, 4000);

    // --- INIT ---
    if(user) {
        document.getElementById('login-nav').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';
        if(user.email === 'admin@arc.com') document.getElementById('teacher-nav').style.display = 'inline';
    }

    // --- NAVIGATION ---
    function show(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'notes') loadMaterials();
        if(id === 'tests') loadTests();
        if(id === 'results') loadResults();
    }
    
    function showAdminTab(id) {
        ['students', 'manage', 'create', 'off-res'].forEach(t => document.getElementById('adm-'+t).style.display = 'none');
        document.getElementById('adm-'+id).style.display = 'block';
        if(id === 'students') loadStudents();
        if(id === 'manage') loadManageList();
    }

    // --- AUTH ---
    function toggleReg() { 
        const b = document.getElementById('reg-box');
        b.style.display = b.style.display === 'none' ? 'block' : 'none';
    }
    async function handleReg() {
        const name = document.getElementById('r-name').value;
        const prefix = document.getElementById('r-prefix').value;
        const pass = document.getElementById('r-pass').value;
        if(!prefix) return alert("Email prefix required");
        
        const res = await fetch('/api/register', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ name, emailPart: prefix, password: pass })
        });
        if((await res.json()).success) { alert("Registered! Login now."); toggleReg(); }
        else alert("Username taken");
    }
    async function handleLogin() {
        const email = document.getElementById('l-email').value;
        const password = document.getElementById('l-pass').value;
        if(email === 'admin@arc.com' && password === 'admin123') {
            localStorage.setItem('arc_user', JSON.stringify({ email, isAdmin: true }));
            location.reload();
            return;
        }
        const res = await fetch('/api/login', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ email, password })
        });
        const data = await res.json();
        if(data.success) {
            localStorage.setItem('arc_user', JSON.stringify({ email, name: data.name }));
            location.reload();
        } else alert("Invalid Login");
    }
    function logout() { localStorage.removeItem('arc_user'); location.reload(); }

    // --- TEACHER: STUDENTS ---
    async function loadStudents() {
        const res = await fetch('/api/admin/students');
        const data = await res.json();
        document.getElementById('student-table').innerHTML = `
            <tr><th>Name</th><th>Email</th><th>Password</th></tr>
            ${data.map(s => `<tr><td>${s.name}</td><td>${s.email}</td><td>${s.password}</td></tr>`).join('')}
        `;
    }

    // --- TEACHER: CREATE CONTENT ---
    // Image Reader
    document.getElementById('m-img-file').addEventListener('change', function() {
        const r = new FileReader();
        r.onload = e => coverImgBase64 = e.target.result;
        r.readAsDataURL(this.files[0]);
    });

    async function uploadMaterial() {
        const title = document.getElementById('m-title').value;
        const desc = document.getElementById('m-desc').value;
        const link = document.getElementById('m-link').value;
        const code = document.getElementById('m-code').value;
        if(!title || !link || !code) return alert("Missing fields!");
        
        await fetch('/api/admin/material', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ title, description: desc, link, accessCode: code, image: coverImgBase64, type:'Book' })
        });
        alert("Uploaded!");
    }

    // Test Creator with Validation
    function addDraftQ() {
        const text = document.getElementById('q-text').value;
        if(!text) return alert("Question text needed");
        draftQs.push({
            text,
            options: [0,1,2,3].map(i => document.getElementById('op'+i).value),
            correct: parseInt(document.getElementById('q-corr').value),
            marks: parseFloat(document.getElementById('q-mark').value),
            negative: parseFloat(document.getElementById('q-neg').value)
        });
        document.getElementById('q-count').innerText = `Questions: ${draftQs.length}`;
        document.getElementById('q-text').value = "";
    }

    async function publishTest() {
        const title = document.getElementById('t-title').value;
        const dur = document.getElementById('t-dur').value;
        const code = document.getElementById('t-code').value;
        
        if(!title || !dur || !code) return alert("‚ö†Ô∏è STOP! Missing Title, Duration or Password.");
        if(draftQs.length === 0) return alert("‚ö†Ô∏è STOP! No questions added.");

        await fetch('/api/admin/test', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ title, duration: dur, accessCode: code, instructions: document.getElementById('t-inst').value, questions: draftQs })
        });
        alert("Test Published!");
        draftQs = [];
    }

    // Offline Result Creator
    function addResRecord() {
        const name = document.getElementById('res-name').value;
        const link = document.getElementById('res-link').value;
        const pass = document.getElementById('res-pass').value;
        if(!name || !link || !pass) return alert("Missing details for student");
        
        draftRecs.push({
            studentName: name,
            marks: document.getElementById('res-marks').value,
            rank: document.getElementById('res-rank').value,
            copyLink: link,
            accessCode: pass
        });
        document.getElementById('res-count').innerText = `Records: ${draftRecs.length}`;
        document.getElementById('res-name').value = "";
        document.getElementById('res-pass').value = "";
    }

    async function publishOfflineResult() {
        const title = document.getElementById('off-title').value;
        if(!title || draftRecs.length === 0) return alert("Missing Title or Records");
        
        await fetch('/api/admin/offline-result', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ title, records: draftRecs })
        });
        alert("Published Results!");
        draftRecs = [];
    }

    // --- TEACHER: MANAGE (DELETE) ---
    async function loadManageList() {
        const [mRes, tRes] = await Promise.all([fetch('/api/materials'), fetch('/api/tests')]);
        const mats = await mRes.json();
        const tests = await tRes.json();
        
        document.getElementById('manage-list').innerHTML = `
            <h4>Tests</h4>
            ${tests.map(t => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee">
                <span>${t.title}</span> 
                <button class="btn-red" style="width:auto; padding:5px" onclick="deleteItem('test', '${t._id}')">Delete</button>
            </div>`).join('')}
            <h4>Materials</h4>
            ${mats.map(m => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee">
                <span>${m.title}</span> 
                <button class="btn-red" style="width:auto; padding:5px" onclick="deleteItem('material', '${m._id}')">Delete</button>
            </div>`).join('')}
        `;
    }
    async function deleteItem(type, id) {
        if(!confirm("Are you sure?")) return;
        await fetch(`/api/admin/${type}/${id}`, { method: 'DELETE' });
        loadManageList();
    }

    // --- STUDENT: MATERIALS ---
    async function loadMaterials() {
        const res = await fetch('/api/materials');
        const data = await res.json();
        document.getElementById('mat-list').innerHTML = data.map(m => `
            <div class="card" onclick="unlockMaterial('${m._id}')" style="cursor:pointer">
                <img src="${m.image || 'https://via.placeholder.com/200?text=No+Cover'}" class="book-cover">
                <h3>${m.title}</h3>
                <p style="color:#666">${m.description || 'No description'}</p>
                <button class="btn-gold" style="width:100%">Click to Open</button>
            </div>
        `).join('');
    }
    async function unlockMaterial(id) {
        const code = prompt("Enter Password to Open:");
        if(!code) return;
        const res = await fetch('/api/material/unlock', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ id, code })
        });
        const data = await res.json();
        if(data.success) window.open(data.link, '_blank');
        else alert("Wrong Password");
    }

    // --- STUDENT: RESULTS ---
    async function loadResults() {
        const res = await fetch('/api/results/offline');
        const data = await res.json();
        document.getElementById('offline-results-list').innerHTML = data.map(r => `
            <div class="card" style="margin-bottom:20px;">
                <h3 style="color:var(--primary)">${r.title} <small>(${new Date(r.date).toLocaleDateString()})</small></h3>
                <table>
                    <tr><th>Rank</th><th>Name</th><th>Marks</th><th>Action</th></tr>
                    ${r.records.sort((a,b)=>a.rank-b.rank).map(rec => `
                        <tr>
                            <td>#${rec.rank}</td>
                            <td>${rec.studentName}</td>
                            <td>${rec.marks}</td>
                            <td><button class="btn-gold" style="padding:5px; font-size:0.8rem" onclick="viewCopy('${r._id}', '${rec._id}')">View Copy</button></td>
                        </tr>
                    `).join('')}
                </table>
            </div>
        `).join('');
    }
    async function viewCopy(resId, recId) {
        const pwd = prompt("Enter YOUR unique password to view copy:");
        if(!pwd) return;
        const res = await fetch('/api/results/unlock-copy', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ resultId: resId, recordId: recId, password: pwd })
        });
        const data = await res.json();
        if(data.success) window.open(data.link, '_blank');
        else alert("Incorrect Password");
    }

    // --- STUDENT: ONLINE TEST (SIMPLE LIST) ---
    async function loadTests() {
        const res = await fetch('/api/tests');
        const data = await res.json();
        document.getElementById('test-list').innerHTML = data.map(t => `
            <div class="card">
                <h3>${t.title}</h3>
                <p>Duration: ${t.duration} Mins</p>
                <button onclick="startTest('${t._id}')">Start Test</button>
            </div>
        `).join('');
    }
    // (Note: The startTest logic from previous version connects here)
    function startTest(id) {
        // Reuse logic from previous complex version or keep simple alert for now
        alert("Please login to the Full Exam Portal to take this test.");
    }
    
    // Heartbeat
    setInterval(()=>fetch('/api/tests').catch(e=>{}), 2*60*1000);
</script>
</body>
</html>